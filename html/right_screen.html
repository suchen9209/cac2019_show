<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>left_screen</title>
    <script src="./js/jquery-1.8.3.js" type="text/javascript"></script>
    <script src="./js/vue.js" type="text/javascript"></script>
    <script src="./js/jquery.tablesort.js" type="text/javascript"></script>
    <style type="text/css">
        .red{
            background: red;
        }
    </style>
</head>
<body>
    <div id ="round">
        ROUND:  {{round}}
    </div>
    
    <table class="sort-table">
        <thead>
            <tr>
            <th>ID</th>
            <th class="number kill">击杀</th>
            <th class="number">助攻</th>
            <th class="number">死亡</th>
            <th>ADR</th>
            <th>health</th>
            </tr>
        </thead>
        <tbody>
        <tr id="pl1" v-bind:class="classObject">
            <td>{{ id }}</td>
            <td>{{ kill }}</td>
            <td>{{ assist }}</td>
            <td>{{ death }}</td>
            <td>{{ adr }}</td>
            <td>{{ health }}</td>
        </tr>
        <tr id="pl2" v-bind:class="classObject">
            <td>{{ id }}</td>
            <td>{{ kill }}</td>
            <td>{{ assist }}</td>
            <td>{{ death }}</td>
            <td>{{ adr }}</td>
            <td>{{ health }}</td>
        </tr>
        <tr id="pl3" v-bind:class="classObject">
            <td>{{ id }}</td>
            <td>{{ kill }}</td>
            <td>{{ assist }}</td>
            <td>{{ death }}</td>
            <td>{{ adr }}</td>
            <td>{{ health }}</td>
        </tr>
        <tr id="pl4" v-bind:class="classObject">
            <td>{{ id }}</td>
            <td>{{ kill }}</td>
            <td>{{ assist }}</td>
            <td>{{ death }}</td>
            <td>{{ adr }}</td>
            <td>{{ health }}</td>
        </tr>
        <tr id="pl5" v-bind:class="classObject">
            <td>{{ id }}</td>
            <td>{{ kill }}</td>
            <td>{{ assist }}</td>
            <td>{{ death }}</td>
            <td>{{ adr }}</td>
            <td>{{ health }}</td>
        </tr>
        </tbody>
    </table>
    <div id='show_kill' style="display: none;">123</div>
    <div id='show_end'  style="display: none;">13333</div>
    <script type="text/javascript">
    $('.sort-table').tablesort();

    $('thead th.number').data('sortBy', function(th, td, sorter) {
        return parseInt(td.text(), 10);
    });
    var player_id_arr = [];
    const {ipcRenderer} = require('electron');
    var team_id = ipcRenderer.sendSync('get_right_team');
    var round = new Vue({
        el:"#round",
        data:{
            round:1
        }
    });
    var pl1 = new Vue({
        el:"#pl1",
        data:{
            id:1,
            kill:0,
            assist:0,
            death:0,
            adr:0,
            health:100
        },
        computed:{
            classObject:function(){
                return {
                    red:this.health == 0
                }
            }
        }
    });
    var pl2 = new Vue({
        el:"#pl2",
        data:{
            id:1,
            kill:0,
            assist:0,
            death:0,
            adr:0,
            health:100
        },
        computed:{
            classObject:function(){
                return {
                    red:this.health == 0
                }
            }
        }
    });
    var pl3 = new Vue({
        el:"#pl3",
        data:{
            id:1,
            kill:0,
            assist:0,
            death:0,
            adr:0,
            health:100
        },
        computed:{
            classObject:function(){
                return {
                    red:this.health == 0
                }
            }
        }
    });
    var pl4 = new Vue({
        el:"#pl4",
        data:{
            id:1,
            kill:0,
            assist:0,
            death:0,
            adr:0,
            health:100
        },
        computed:{
            classObject:function(){
                return {
                    red:this.health == 0
                }
            }
        }
    });
    var pl5 = new Vue({
        el:"#pl5",
        data:{
            id:1,
            kill:0,
            assist:0,
            death:0,
            adr:0,
            health:100
        },
        computed:{
            classObject:function(){
                return {
                    red:this.health == 0
                }
            }
        }
    });
    var cons = [pl1,pl2,pl3,pl4,pl5];
    var time = setInterval(function(){
        $.ajax({
            type:"GET",
            url:'http://seed.fakecn.com:16443/cas/fresh_data.php',
            success: function(data){
                if(data.success && data.data!=null && data.data.players[0] != undefined){
                    showData(data.data);
                }
                
            },
            error:function(){
            }
        });
    },1000);

    //记录本小局开始时各选手的击杀数，判定小局结束时（cur_round不同于传来的round），各选手击杀数是否有3杀及以上
    //初始化
    var first_open = true;
    var cur_round = 0;
    var player_kill = new Array();
    var cur_kill_show = false;

    function showData(data){
        //表格部分
        if(player_id_arr.length == 0){
            for (var i in data.players){
                if (data.players[i].player_info.team_id == team_id){
                    player_id_arr.push(data.players[i].player_info.id);
                } 
            } 
        }
        
        round.round = data.round;
        var players = data.players;
        var player_objs = {};
        for(var key in players){
            player_objs[players[key].player_info.id] = players[key];
        }
        for (var i = 0; i< player_id_arr.length; i++) {
            cons[i].id = player_objs[player_id_arr[i]].player_info.id;
            cons[i].kill = player_objs[player_id_arr[i]].kill;
            cons[i].assist = player_objs[player_id_arr[i]].assist;
            cons[i].death = player_objs[player_id_arr[i]].death;
            cons[i].health = player_objs[player_id_arr[i]].health;
        }
        $(".kill").click();

        //多杀显示部分
        //首次打开页面，根据接口内容初始化
        if(first_open){
            cur_round = data.round;
            for (var i = 0; i< player_id_arr.length; i++) {
                player_kill[player_id_arr[i]] = player_objs[player_id_arr[i]].kill;
            }
            first_open = false;
        }
        //根据rounds中对应round的win_type字段判断是否已决出胜负
        if(cur_round==data.round && data.rounds[cur_round-1].win_type != 0){//本局小局已出结果
            var cur_player_kill_most = {};
            for (var i = 0; i< player_id_arr.length; i++) {
                if(player_objs[player_id_arr[i]].kill - player_kill[player_id_arr[i]] >= 3){
                    cur_player_kill_most.id = player_objs[player_id_arr[i]].player_info.id;
                    cur_player_kill_most.kill = player_objs[player_id_arr[i]].kill - player_kill[player_id_arr[i]];
                }
            }
            //有多杀队员
            if(!$.isEmptyObject(cur_player_kill_most)){//判断是否存在多杀
                //显示多杀队员信息
                if (!cur_kill_show){
                    $("#show_kill").html(cur_player_kill_most.id); 
                    $("#show_kill").show();
                    cur_kill_show=true;//用于判断本局是否已显示过多杀
                    setTimeout(function(){
                        $("#show_kill").hide();
                    },1500);//1.5s后隐藏
                }
            }

            //显示3秒 小局胜利的结果
            //win_type   1:炸弹爆炸, 7 炸弹被拆除，8 警察赢 ,9 匪徒赢, 12 匪徒时间用光
            //win_camp   2:土匪，3：警察
            switch (data.rounds[cur_round-1].win_type){
                case 1:
                    $("#show_end").html('炸弹爆炸');
                    break;
                case 7:
                    $("#show_end").html('炸弹被拆除');
                    break;
                case 8:
                    $("#show_end").html('警察赢');
                    break;
                case 9:
                    $("#show_end").html('匪徒赢');
                    break;
                case 12:
                    $("#show_end").html('匪徒时间用光');
                    break;
                default:
                    //do nothing;
            }
            $("#show_end").show();

            
            

        }
        //判断是否为新的一局
        if(cur_round != data.round){
            cur_round = data.round;
            for (var i = 0; i< player_id_arr.length; i++) {
                player_kill[player_id_arr[i]] = player_objs[player_id_arr[i]].kill;
            }
            cur_kill_show = false;//用于判断本局是否已显示过多杀
            $("#show_end").hide();
        }
        //更新每小局开始时的初始信息

    }


    </script>
</body>
</html>